<!doctype html>
<html lang="en">
  <head>
    <!-- Head content -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Domain Security Analyzer</title>
    <!-- Import fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <!-- Include jQuery library -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
      /* Reset and basic styles */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'Inter', sans-serif;
        background-color: #f0f4f8;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
      }

      /* Main container */
      .container {
        background-color: #fff;
        width: 90%;
        max-width: 600px;
        border-radius: 12px;
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        padding: 40px;
        text-align: center;
        position: relative;
      }

      /* Input form styles */
      .form-container {
        margin-bottom: 30px;
      }

      label {
        display: block;
        font-weight: 600;
        margin-bottom: 10px;
        font-size: 1.1em;
      }

      input[type="text"] {
        padding: 15px;
        width: 100%;
        max-width: 400px;
        border: 1px solid #ccc;
        border-radius: 8px;
        font-size: 1em;
      }

      button {
        margin-top: 20px;
        padding: 15px 30px;
        background-color: #2f855a; /* Forest green */
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 1em;
        cursor: pointer;
        transition: background-color 0.3s ease;
      }

      button:hover {
        background-color: #276749;
      }

      button:disabled {
        background-color: #aaa;
        cursor: not-allowed;
      }

      /* Status indicator */
      .status-indicator {
        display: inline-block;
        width: 14px;
        height: 14px;
        border-radius: 50%;
        margin-right: 8px;
        vertical-align: middle;
      }

      .status-green {
        background-color: #2f855a;
      }

      .status-red {
        background-color: #c53030;
      }

      .status-yellow {
        background-color: #d69e2e;
      }

      /* Summary and recommendations */
      .summary-card, .recommendations-card, .domain-info-card {
        text-align: left;
        margin-top: 20px;
      }

      .summary-card h2, .domain-info-card h3, .recommendations-card h3 {
        margin-bottom: 15px;
        color: #2d3748;
      }

      .summary-card p, .domain-info-card p, .recommendations-card p {
        margin-bottom: 10px;
        line-height: 1.6;
        color: #4a5568;
      }

      .summary-card ul, .recommendations-card ul {
        list-style-type: disc;
        margin-left: 20px;
      }

      /* Show details button */
      #show-details-button {
        margin-top: 30px;
        padding: 12px 24px;
        background-color: #2b6cb0; /* Blue color */
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 1em;
        cursor: pointer;
        transition: background-color 0.3s ease;
      }

      #show-details-button:hover {
        background-color: #2c5282;
      }

      /* Detailed results */
      .results-container {
        margin-top: 20px;
        text-align: left;
        display: none;
      }

      .record-card {
        background: #edf2f7;
        padding: 20px;
        margin-bottom: 15px;
        border-radius: 8px;
      }

      .record-card h3 {
        margin-bottom: 10px;
        color: #2d3748;
      }

      .record-card p, .record-card ul {
        color: #4a5568;
        line-height: 1.6;
      }

      .record-card ul {
        list-style-type: disc;
        margin-left: 20px;
      }

      /* Loader */
      .loader {
        border: 6px solid #f3f3f3;
        border-top: 6px solid #2f855a; /* Forest green */
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        display: none;
        margin: 20px auto;
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      /* Error message */
      .error {
        color: #c53030;
        margin-top: 20px;
      }

      /* Responsive adjustments */
      @media (max-width: 600px) {
        .container {
          padding: 20px;
        }

        input[type="text"] {
          width: 100%;
        }
      }
    </style>         
  </head>
  <body>
    <div class="container">
      <div class="form-container">
        <form id="lookup-form">
          <label for="domain">Domain Name</label>
          <input type="text" id="domain" name="domain" placeholder="e.g., example.com" required>
          <button type="submit" id="lookup-button">Analyze</button>
        </form>
        <div id="loading-spinner" class="loader"></div>
        <div id="error" class="error"></div>
      </div>
      <div id="summary" class="summary-card" style="display: none;"></div>
      <div id="domain-info" class="domain-info-card" style="display: none;"></div>
      <div id="recommendations" class="recommendations-card" style="display: none;"></div>
      <button id="show-details-button" style="display: none;">Show Detailed DNS Records</button>
      <div id="results" class="results-container"></div>
    </div>
    <!-- Custom JavaScript -->
    <script>
      $(document).ready(function() {
        $("#lookup-form").on("submit", function(event) {
          event.preventDefault();
          var domain = $("#domain").val();
          $("#lookup-button").prop("disabled", true);
          $("#loading-spinner").show();
          $("#error").text("");
          $("#results").empty().hide();
          $("#summary").empty().hide();
          $("#domain-info").empty().hide();
          $("#recommendations").empty().hide();
          $("#show-details-button").hide();
  
          $.ajax({
            url: "/lookup",
            type: "POST",
            data: { domain: domain },
            success: function(response) {
              $("#lookup-button").prop("disabled", false);
              $("#loading-spinner").hide();
              
              if (response.error) {
                $("#error").text(response.error);
              } else {
                // Build the summary section (Security Score and DMARC Info at the top)
                var summaryHtml = "<h2>Domain Security Analysis for " + response.domain + "</h2>";
                summaryHtml += "<h3>Security Score: " + response.score + " / " + response.max_score + "</h3>";
                summaryHtml += "<ul>";
  
                function getRecordStatusIndicator(statusText) {
                  if (statusText.includes("Not Found") || statusText.includes("Could be improved") || statusText.includes("Policy not recognized") || statusText.includes("Policy not found")) {
                    return "<span class='status-indicator status-red'></span>";
                  } else if (statusText.includes("Found") || statusText.includes("Good") || statusText.includes("reject")) {
                    return "<span class='status-indicator status-green'></span>";
                  } else {
                    return "<span class='status-indicator status-yellow'></span>";
                  }
                }
  
                summaryHtml += "<li>" + getRecordStatusIndicator(response.dmarc_status) + "DMARC Status: " + response.dmarc_status + "</li>";
                summaryHtml += "<li>" + getRecordStatusIndicator(response.spf_status) + "SPF Status: " + response.spf_status + "</li>";
                summaryHtml += "<li>" + getRecordStatusIndicator(response.dkim_status) + "DKIM Status: " + response.dkim_status + "</li>";
                summaryHtml += "</ul>";
  
                $("#summary").html(summaryHtml).fadeIn();
  
                // Build the domain information section
                var domainInfoHtml = "<h3>Domain Information</h3>";
                domainInfoHtml += "<p>" + response.expiration_info + "</p>";
                domainInfoHtml += "<p>" + response.registrar_info + "</p>";
  
                // Website Accessibility and SSL Validation
                function getStatusIndicator(statusText) {
                  if (statusText === "good") {
                    return "<span class='status-indicator status-green'></span>";
                  } else if (statusText === "warning") {
                    return "<span class='status-indicator status-yellow'></span>";
                  } else {
                    return "<span class='status-indicator status-red'></span>";
                  }
                }
  
                if (response.website_status.accessible) {
                  domainInfoHtml += "<p>" + getStatusIndicator("good") + "<strong>Website Accessible:</strong> Yes (Status Code: " + response.website_status.status_code + ")</p>";
                } else {
                  domainInfoHtml += "<p>" + getStatusIndicator("bad") + "<strong>Website Accessible:</strong> No (" + response.website_status.error + ")</p>";
                }
  
                if (response.website_status.ssl_valid) {
                  domainInfoHtml += "<p>" + getStatusIndicator("good") + "<strong>SSL Certificate Valid:</strong> Yes</p>";
                } else {
                  domainInfoHtml += "<p>" + getStatusIndicator("bad") + "<strong>SSL Certificate Valid:</strong> No</p>";
                }
  
                // Display Email Security Tools
                if (response.email_security_tools.length > 0) {
                  domainInfoHtml += "<p><strong>Email Security Tools Detected:</strong> " + response.email_security_tools.join(", ") + "</p>";
                }
  
                if (response.unknown_mx_providers.length > 0) {
                  domainInfoHtml += "<p><strong>Unknown MX Providers:</strong> " + response.unknown_mx_providers.join(", ") + "</p>";
                  domainInfoHtml += "<p>These MX records do not match known providers. Consider investigating them further.</p>";
                }
  
                if (response.email_security_tools.length === 0 && response.unknown_mx_providers.length === 0) {
                  domainInfoHtml += "<p><strong>Email Security Tools Detected:</strong> None found. It's unclear if an email security provider is in use.</p>";
                }
  
                $("#domain-info").html(domainInfoHtml).fadeIn();
  
                // Build the recommendations section
                var recommendations = "<h3>Recommendations</h3><ul>";
  
                if (response.dmarc_status.includes("Could be improved") || response.dmarc_status.includes("Not Found")) {
                  recommendations += "<li>Consider implementing or strengthening DMARC policies to protect against email spoofing.</li>";
                }
  
                if (response.spf_status === "SPF Record Not Found") {
                  recommendations += "<li>Add an SPF record to specify authorized email servers.</li>";
                }
  
                if (response.dkim_status === "DKIM Record Not Found") {
                  recommendations += "<li>Implement DKIM to verify email authenticity.</li>";
                }
  
                if (response.email_security_tools.length === 0 && response.unknown_mx_providers.length > 0) {
                  recommendations += "<li>The MX records do not match known email security providers. Consider investigating these MX records: " + response.unknown_mx_providers.join(", ") + ".</li>";
                } else if (response.email_security_tools.length === 0 && response.unknown_mx_providers.length === 0) {
                  recommendations += "<li>It's unclear if an email security provider is in use. Consider verifying this and exploring email security solutions if not in place.</li>";
                }
  
                if (!response.website_status.accessible) {
                  recommendations += "<li>Website is not accessible. Investigate the issue to ensure your site is reachable.</li>";
                }
  
                if (!response.website_status.ssl_valid) {
                  recommendations += "<li>SSL certificate is not valid. Consider renewing or configuring SSL to secure your site.</li>";
                }
  
                if (response.highlighted_info.includes("Discrepancies Detected")) {
                  recommendations += "<li>DNS discrepancies detected between resolvers. Verify your DNS configurations and allow time for changes to propagate.</li>";
                }
  
                recommendations += "</ul>";
                $("#recommendations").html(recommendations).fadeIn();
  
                // Show the "Show Details" button
                $("#show-details-button").fadeIn();
  
                // Prepare the detailed results section but keep it hidden
                var resultsHtml = "<h2>Detailed DNS Records for " + response.domain + "</h2>";
                $.each(response.results, function(recordType, recordData) {
                  var recordStatusIndicator = "";
                  if (recordData.cloudflare && recordData.cloudflare.length > 0) {
                    recordStatusIndicator = "<span class='status-indicator status-green'></span>";
                  } else {
                    recordStatusIndicator = "<span class='status-indicator status-red'></span>";
                  }
                  
                  resultsHtml += "<div class='record-card'>";
                  resultsHtml += "<h3>" + recordStatusIndicator + recordType + " Records</h3>";
                  
                  if (recordData.cloudflare && recordData.cloudflare.length > 0) {
                    resultsHtml += "<p><strong>Cloudflare DNS Results:</strong></p>";
                    resultsHtml += "<ul>";
                    $.each(recordData.cloudflare, function(index, value) {
                      resultsHtml += "<li>" + value + "</li>";
                    });
                    resultsHtml += "</ul>";
                  } else {
                    resultsHtml += "<p>No " + recordType + " records found on Cloudflare DNS.</p>";
                  }
                  
                  if (recordData.google && recordData.google.length > 0) {
                    resultsHtml += "<p><strong>Google DNS Results (Differing):</strong></p>";
                    resultsHtml += "<ul>";
                    $.each(recordData.google, function(index, value) {
                      resultsHtml += "<li>" + value + "</li>";
                    });
                    resultsHtml += "</ul>";
                  }
    
                  if (recordData.verification) {
                    resultsHtml += "<p style='color: blue;'><strong>Verification:</strong> " + recordData.verification + "</p>";
                  }
    
                  if (recordData.discrepancies) {
                    resultsHtml += "<p style='color: red;'><strong>Discrepancies Detected:</strong> " + recordData.discrepancies.join(", ") + "</p>";
                    resultsHtml += "<p>This may be due to recent DNS changes or misconfigurations. Consider checking your DNS settings.</p>";
                  }
    
                  if (recordData.explanation) {
                    resultsHtml += "<p><em>Explanation:</em><br>" + recordData.explanation.replace(/\n/g, "<br>") + "</p>";
                  }
    
                  resultsHtml += "</div>";
                });
    
                $("#results").html(resultsHtml);
              }
            },
            error: function(xhr, status, error) {
              console.error(error);
              $("#lookup-button").prop("disabled", false);
              $("#loading-spinner").hide();
              $("#error").text("An error occurred while processing your request: " + error);
            }
          });
        });
  
        // Toggle detailed results display
        $("#show-details-button").on("click", function() {
          if ($("#results").is(":visible")) {
            $("#results").slideUp();
            $(this).text("Show Detailed DNS Records");
          } else {
            $("#results").slideDown();
            $(this).text("Hide Detailed DNS Records");
          }
        });
      });
    </script> 
  </body>
</html>